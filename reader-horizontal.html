<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Lecteur Manga</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      height: 100%;
      overflow: hidden;
    }
    #reader {
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    .page {
      display: none;
      width: 100%;
      height: 100%;
      justify-content: center;
      align-items: center;
    }
    .page img {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
      user-select: none;
      pointer-events: none;
    }
    #reader.vertical {
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-snap-type: y mandatory;
      justify-content: flex-start;
    }
    #reader.vertical .page {
      display: flex;
      scroll-snap-align: start;
      width: auto;
      height: auto;
      max-width: 100vw;
      max-height: 98vh;
      margin: 1vh auto;
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    #controls button {
      background: #222;
      border: none;
      color: #eee;
      padding: 8px 15px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 0 8px #0008;
      user-select: none;
    }
    #page-counter {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #222a;
      padding: 6px 12px;
      border-radius: 8px;
      font-family: monospace;
      font-weight: bold;
      font-size: 18px;
      user-select: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <div id="controls">
    <button id="btn-back">‚Üê Retour</button>
    <button id="btn-toggle-mode">Mode lecture : Horizontal</button>
  </div>

  <div id="reader"></div>

  <div id="page-counter">Page 0 / 0</div>

  <script src="mangas-data.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const chapId = urlParams.get('chap');
    const lang = urlParams.get('lang') || 'fr';

    const reader = document.getElementById('reader');
    const btnBack = document.getElementById('btn-back');
    const btnToggleMode = document.getElementById('btn-toggle-mode');
    const pageCounter = document.getElementById('page-counter');

    let totalPages = 0;
    let currentPage = 0;
    let verticalMode = false;
    let pages = [];

    let manga = null;
    let chapter = null;

    for (const m of mangas) {
      const c = m.chapters.find(ch => ch.id === chapId);
      if (c) {
        manga = m;
        chapter = c;
        break;
      }
    }

    if (!chapter) {
      reader.innerHTML = "<p style='color:red; text-align:center; padding:20px;'>Chapitre introuvable.</p>";
    } else {
      loadPages();
    }

    async function loadPages() {
      const folder = chapter.pages[lang] || chapter.pages['fr'];
      let i = 1;
    
      while (true) {
        const img = new Image();
        const fileName = `${folder}${String(i).padStart(3, '0')}.png`;
        img.src = fileName;
    
        const loaded = await new Promise(resolve => {
          img.onload = () => resolve(true);
          img.onerror = () => resolve(false);
        });
    
        if (!loaded) break;
    
        const pageDiv = document.createElement('div');
        pageDiv.className = 'page';
        pageDiv.appendChild(img);
        reader.appendChild(pageDiv);
    
        i++;
      }
    
      pages = Array.from(reader.children);
      totalPages = pages.length;
    
      if (!verticalMode) {
        reader.style.overflow = 'hidden';
        currentPage = totalPages - 1;
        updatePageVisibility();
        goToPage(currentPage);
      }
    
      updatePageCounter();
    }


    function updatePageCounter() {
      pageCounter.textContent = `Page ${currentPage + 1} / ${totalPages}`;
    }

    function updatePageVisibility() {
      pages.forEach((p, i) => {
        p.style.display = (verticalMode || i === currentPage) ? "flex" : "none";
      });
    }

    function goToPage(index) {
      index = Math.max(0, Math.min(index, totalPages - 1));
      currentPage = index;

      if (verticalMode) {
        const page = pages[currentPage];
        if (page) {
          page.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      } else {
        updatePageVisibility();
      }

      updatePageCounter();
    }

    btnToggleMode.onclick = () => {
      verticalMode = !verticalMode;

      if (verticalMode) {
        reader.classList.add('vertical');
        reader.style.overflow = 'auto';
        btnToggleMode.textContent = "Mode lecture : Vertical";
        reader.scrollTop = 0;
      } else {
        reader.classList.remove('vertical');
        reader.style.overflow = 'hidden';
        btnToggleMode.textContent = "Mode lecture : Horizontal";
        goToPage(currentPage);
      }

      updatePageVisibility();
      updatePageCounter();
    };

    btnBack.onclick = () => {
      if (manga) {
        window.location.href = `manga-hub.html?manga=${encodeURIComponent(manga.id)}`;
      } else {
        window.location.href = "manga-hub.html";
      }
    };

    document.addEventListener("click", (e) => {
      if (verticalMode) return;

      const clickX = e.clientX;
      const screenWidth = window.innerWidth;

      if (clickX < screenWidth * 0.3) {
        goToPage(currentPage + 1);
      } else if (clickX > screenWidth * 0.7) {
        goToPage(currentPage - 1);
      }
    });
  </script>
</body>
</html>

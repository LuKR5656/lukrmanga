<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Lecteur Manga</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #111;
      color: #fff;
      font-family: sans-serif;
      height: 100%;
      overflow: hidden;
    }
    #reader {
      display: flex;
      flex-direction: row; /* horizontal par défaut */
      justify-content: flex-end;
      width: 100vw;
      height: 100vh;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-behavior: smooth;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }
    #reader.vertical {
      flex-direction: column;
      overflow-y: auto;
      overflow-x: hidden;
      scroll-snap-type: y mandatory;
      justify-content: flex-start;
    }
    .page {
      scroll-snap-align: start;
      flex-shrink: 0;
      width: 98vw;
      height: 98vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: auto 1vw;
    }
    #reader.vertical .page {
      width: auto;
      height: auto;
      max-width: 100vw;
      max-height: 98vh;
      margin: 1vh auto;
    }
    .page img {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;
      user-select: none;
      pointer-events: none;
    }
    #controls {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1000;
      display: flex;
      gap: 10px;
    }
    #controls button {
      background: #222;
      border: none;
      color: #eee;
      padding: 8px 15px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 0 8px #0008;
      user-select: none;
    }
    #page-counter {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #222a;
      padding: 6px 12px;
      border-radius: 8px;
      font-family: monospace;
      font-weight: bold;
      font-size: 18px;
      user-select: none;
      z-index: 1000;
    }
  </style>
</head>
<body>

  <div id="controls">
    <button id="btn-back">← Retour</button>
    <button id="btn-toggle-mode">Mode lecture : Horizontal</button>
  </div>

  <div id="reader"></div>

  <div id="page-counter">Page 0 / 0</div>

  <script src="mangas-data.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const chapId = urlParams.get('chap');
    const lang = urlParams.get('lang') || 'fr';

    const reader = document.getElementById('reader');
    const btnBack = document.getElementById('btn-back');
    const btnToggleMode = document.getElementById('btn-toggle-mode');
    const pageCounter = document.getElementById('page-counter');

    let totalPages = 0;
    let currentPage = 1;
    let verticalMode = false;

    // Recherche du manga et chapitre dans mangas-data.js
    let manga = null;
    let chapter = null;

    for (const m of mangas) {
      const c = m.chapters.find(ch => ch.id === chapId);
      if (c) {
        manga = m;
        chapter = c;
        break;
      }
    }

    if (!chapter) {
      reader.innerHTML = "<p style='color:red; text-align:center; padding:20px;'>Chapitre introuvable.</p>";
    } else {
      loadPages();
    }

    async function loadPages() {
      const folder = chapter.pages[lang] || chapter.pages['fr'];
      let i = 1;

      while (true) {
        const img = new Image();
        // Construire le chemin complet de l'image (ex: pages/bp/chap1/fr/001.png)
        const fileName = `${folder}${String(i).padStart(3, '0')}.png`;
        img.src = fileName;

        try {
          await img.decode();

          const pageDiv = document.createElement('div');
          pageDiv.className = 'page';
          pageDiv.appendChild(img);
          reader.appendChild(pageDiv);

          i++;
        } catch (e) {
          break;
        }
      }
      totalPages = reader.children.length;
      updatePageCounter();

      // Scroll initial à droite (début du manga en lecture horizontale droite->gauche)
      reader.scrollLeft = reader.scrollWidth;
    }

    function updatePageCounter() {
      if (totalPages === 0) {
        pageCounter.textContent = "Page 0 / 0";
        return;
      }

      const pages = Array.from(reader.children);
      let visibleIndex = 1;

      if (verticalMode) {
        const scrollPos = reader.scrollTop + window.innerHeight / 2;
        for (let i = 0; i < pages.length; i++) {
          const pageTop = pages[i].offsetTop;
          const pageBottom = pageTop + pages[i].offsetHeight;
          if (scrollPos >= pageTop && scrollPos <= pageBottom) {
            visibleIndex = i + 1;
            break;
          }
        }
      } else {
        const scrollPos = reader.scrollLeft + window.innerWidth / 2;
        for (let i = 0; i < pages.length; i++) {
          const pageLeft = pages[i].offsetLeft;
          const pageRight = pageLeft + pages[i].offsetWidth;
          if (scrollPos >= pageLeft && scrollPos <= pageRight) {
            visibleIndex = i + 1;
            break;
          }
        }
      }

      currentPage = visibleIndex;
      pageCounter.textContent = `Page ${currentPage} / ${totalPages}`;
    }

    reader.addEventListener('scroll', updatePageCounter);

    btnToggleMode.onclick = () => {
      verticalMode = !verticalMode;
      if (verticalMode) {
        reader.classList.add('vertical');
        btnToggleMode.textContent = "Mode lecture : Vertical";
        reader.scrollTop = 0;
      } else {
        reader.classList.remove('vertical');
        btnToggleMode.textContent = "Mode lecture : Horizontal";
        reader.scrollLeft = reader.scrollWidth;
      }
      updatePageCounter();
    };

    btnBack.onclick = () => {
      if (manga) {
        const url = `manga-hub.html?manga=${encodeURIComponent(manga.id)}`;
        window.location.href = url;
      } else {
        window.location.href = "manga-hub.html";
      }
    };
  </script>
</body>
</html>

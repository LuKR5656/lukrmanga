<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Lecture Manga</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      background: #111;
      overflow: hidden;
      font-family: sans-serif;
      color: #fff;
      -webkit-user-select: none;
      user-select: none;
      touch-action: manipulation;
      position: relative;
    }

    #reader {
      display: flex;
      flex-direction: row-reverse; /* lecture de droite √† gauche */
      height: 100vh;
      width: 100vw;
      overflow: hidden; /* bloque scroll natif */
      position: relative;
      scroll-behavior: smooth;
    }

    .page {
      flex: 0 0 100vw;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      -webkit-user-drag: none;
      position: relative;
    }

    .page img {
      max-height: 95vh;
      max-width: 95vw;
      object-fit: contain;
      pointer-events: none; /* clic passe √† #reader */
      user-select: none;
      -webkit-user-drag: none;
      box-shadow: 0 0 20px #0009;
      border-radius: 8px;
      background: #222;
    }

    /* Barre d'info (footer) */
    #info-overlay {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(20, 20, 20, 0.95);
      color: #eee;
      backdrop-filter: blur(8px);
      padding: 15px 20px;
      display: none;
      box-sizing: border-box;
      box-shadow: 0 -2px 10px #0009;
      font-size: 16px;
      user-select: text;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    #info-text {
      flex: 1 1 60%;
      min-width: 200px;
      line-height: 1.3;
      font-weight: 500;
    }

    #info-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: nowrap;
      flex: 1 1 35%;
      min-width: 150px;
      justify-content: flex-end;
    }

    #info-buttons button {
      background: transparent;
      border: 2px solid #eee;
      color: #eee;
      border-radius: 6px;
      padding: 10px 18px;
      font-size: 16px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s, color 0.3s;
      user-select: none;
    }

    #info-buttons button:hover {
      background-color: #eee;
      color: #111;
    }

    /* Num√©ro de page */
    #page-number {
      position: fixed;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      color: #ccc;
      text-shadow: 0 0 5px #0008;
      user-select: none;
      z-index: 15;
      pointer-events: none;
      font-weight: 600;
      font-family: monospace;
      letter-spacing: 0.1em;
    }

  </style>
</head>
<body>
  <div id="reader"></div>

  <div id="page-number">Page 1 / 1</div>

  <div id="info-overlay" role="dialog" aria-modal="true" aria-label="Informations du chapitre">
    <div id="info-text">
      <div><strong id="manga-title">Titre Manga</strong></div>
      <div>Auteur : <span id="manga-author">Inconnu</span></div>
      <div>Chapitre : <span id="chapter-title">Titre Chapitre</span></div>
    </div>
    <div id="info-buttons">
      <button id="btn-back-to-hub" aria-label="Retour au manga hub">‚Ü©Ô∏èManga Hub</button>
      <button id="btn-toggle-mode" aria-label="Changer le mode de lecture">üìúChanger mode</button>
    </div>
  </div>

  <script src="mangas-data.js"></script>
  <script>
    (() => {
      const urlParams = new URLSearchParams(window.location.search);
      const chapId = urlParams.get('chap');
      let lang = urlParams.get('lang') || 'fr';
      let readingMode = urlParams.get('mode') || 'horizontal'; // peut √™tre 'horizontal' ou 'vertical'

      const chapter = mangas.flatMap(m => m.chapters.map(c => ({...c, manga: m}))).find(c => c.id === chapId);

      const reader = document.getElementById('reader');
      const pageNumber = document.getElementById('page-number');
      const infoOverlay = document.getElementById('info-overlay');
      const mangaTitleEl = document.getElementById('manga-title');
      const mangaAuthorEl = document.getElementById('manga-author');
      const chapterTitleEl = document.getElementById('chapter-title');
      const btnBackToHub = document.getElementById('btn-back-to-hub');
      const btnToggleMode = document.getElementById('btn-toggle-mode');

      if (!chapter) {
        reader.textContent = "Chapitre non trouv√©.";
        return;
      }

      mangaTitleEl.textContent = chapter.manga.title || "Titre inconnu";
      mangaAuthorEl.textContent = chapter.manga.author || "Inconnu";
      chapterTitleEl.textContent = chapter.title?.[lang] || "Chapitre";

      // Fonction pour charger dynamiquement les images tant qu'elles existent
      async function loadImages(folder, extension = 'png') {
        let index = 1;
        while (true) {
          let filename = `${folder}${index.toString().padStart(3, '0')}.${extension}`;
          // V√©rifier si l'image existe par pr√©chargement
          try {
            await new Promise((resolve, reject) => {
              const img = new Image();
              img.onload = () => resolve(true);
              img.onerror = () => reject(false);
              img.src = filename;
            });
            // Si charg√©e, cr√©er la page
            const pageDiv = document.createElement('div');
            pageDiv.className = 'page';
            const imgEl = document.createElement('img');
            imgEl.src = filename;
            pageDiv.appendChild(imgEl);
            reader.appendChild(pageDiv);
            index++;
          } catch {
            break; // Fin du chargement
          }
        }
      }

      // Initialisation du lecteur
      async function initReader() {
        const folder = chapter.pages?.[lang] || chapter.pages?.fr || '';
        await loadImages(folder);

        if (reader.children.length === 0) {
          reader.textContent = "Aucune page disponible.";
          return;
        }

        currentIndex = 0;
        scrollToPage(currentIndex);
        updatePageNumber();
      }

      // Scroll vers une page (index)
      function scrollToPage(idx) {
        if (idx < 0) idx = 0;
        if (idx >= reader.children.length) idx = reader.children.length - 1;
        currentIndex = idx;
        const page = reader.children[idx];
        if (!page) return;
        const offsetLeft = page.offsetLeft;
        reader.scrollTo({left: offsetLeft, behavior: 'smooth'});
      }

      // Mise √† jour du num√©ro de page (affich√© en lecture droite‚Üígauche)
      function updatePageNumber() {
        const total = reader.children.length;
        const pageNum = total - currentIndex;
        pageNumber.textContent = `Page ${pageNum} / ${total}`;
      }

      // Navigation pages
      function nextPage() { // page suivante ‚Üí index -1 (car flex-row-reverse)
        if (currentIndex < reader.children.length - 1) {
          scrollToPage(currentIndex + 1);
          updatePageNumber();
        }
      }

      function prevPage() { // page pr√©c√©dente ‚Üí index +1
        if (currentIndex > 0) {
          scrollToPage(currentIndex - 1);
          updatePageNumber();
        }
      }

      // Gestion des clics pour navigation et overlay
      reader.addEventListener('click', (e) => {
        if (infoOverlay.style.display === 'flex') return; // ignore clics sous overlay

        const w = window.innerWidth;
        const x = e.clientX;

        if (x < w/3) {
          // Tiers gauche ‚Üí page suivante
          nextPage();
        } else if (x > 2*w/3) {
          // Tiers droit ‚Üí page pr√©c√©dente
          prevPage();
        } else {
          // Tiers central ‚Üí toggle overlay
          showOverlay();
        }
      });

      // Variable currentIndex
      let currentIndex = 0;

      // Scroll manuel via clavier (optionnel)
      window.addEventListener('keydown', (e) => {
        if (infoOverlay.style.display === 'flex') return;
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') nextPage();
        else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') prevPage();
      });

      // Affiche la barre d'info overlay
      function showOverlay() {
        infoOverlay.style.display = 'flex';
      }

      // Cache la barre d'info overlay
      function hideOverlay() {
        infoOverlay.style.display = 'none';
      }

      // Fermer overlay en cliquant hors boutons
      infoOverlay.addEventListener('click', (e) => {
        if (e.target.tagName.toLowerCase() === 'button') return; // pas fermer si bouton
        hideOverlay();
      });

      // Bouton retour au hub
      btnBackToHub.addEventListener('click', () => {
        window.location.href = `manga-hub.html?manga=${chapter.manga.id}`;
      });

      // Bouton changement mode de lecture (juste reload avec param√®tre)
      btnToggleMode.addEventListener('click', () => {
        let newMode = readingMode === 'horizontal' ? 'vertical' : 'horizontal';
        // Reload en conservant les param√®tres + mode
        const baseUrl = window.location.pathname;
        const searchParams = new URLSearchParams(window.location.search);
        searchParams.set('mode', newMode);
        window.location.href = `${baseUrl}?${searchParams.toString()}`;
      });

      // Initialisation
      initReader();
    })();
  </script>
</body>
</html>

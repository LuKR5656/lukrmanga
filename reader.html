<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecteur Manga</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html,body {margin:0;padding:0; height:100%; background:#181818;}
    #reader {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:#181818; display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    #main-image {
      max-width:100vw; max-height:82vh; display:block; margin:auto; background:#222; border-radius:10px; box-shadow:0 4px 28px #000a;
      cursor:pointer;
      transition: box-shadow .2s;
    }
    #main-image:active {box-shadow:0 0 32px #ffd700;}
    #overlay {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(0,0,0,.78); display:none; z-index:10; color:#fff;
      align-items:center; justify-content:center;
    }
    #overlay-content {
      background:rgba(32,32,32,.98); border-radius:18px; padding:30px 18px; min-width:280px; min-height:170px;
      box-shadow:0 0 22px #000b; text-align:center;
    }
    #controls {
      margin:20px auto 0 auto; display:flex; gap:18px; justify-content:center; align-items:center;
    }
    #thumbs {
      width:100vw; overflow-x:auto; display:flex; gap:5px; background:#202020;
      padding:8px 0 7px 0; box-shadow:0 -8px 16px #000a;
    }
    .thumb {
      width:66px; height:90px; object-fit:cover; border-radius:7px;
      cursor:pointer; opacity:.6; border:2px solid transparent; transition:.2s;
    }
    .thumb.selected,.thumb:hover {opacity:1; border:2px solid #ffd700;}
    #chaptitle {font-size:1.25em; margin-bottom:7px;}
    #mangatitle {font-weight:bold; font-size:1.5em; margin-bottom:3px;}
    #page-indicator {margin-top:10px; color:#ffd700;}
    button {
      background:#ffd700; border:none; border-radius:7px; padding:10px 18px; font-size:1em; cursor:pointer; font-weight:bold;
      box-shadow:0 2px 8px #0005;
    }
    button:hover {background:#fff666;}
    @media (max-width:700px) {
      #main-image {max-width:100vw; max-height:60vh;}
      .thumb {width:36px;height:54px;}
      #overlay-content{min-width:90vw;}
    }
  </style>
</head>
<body>
  <div id="reader">
    <img id="main-image" src="" alt="Page Manga">
    <div id="thumbs"></div>
  </div>
  <div id="overlay">
    <div id="overlay-content">
      <div id="mangatitle"></div>
      <div id="chaptitle"></div>
      <div id="page-indicator"></div>
      <div id="controls">
        <button id="prev-btn">⏪</button>
        <button id="next-btn">⏩</button>
        <button id="back-btn">Retour</button>
      </div>
    </div>
  </div>
  <script src="manga-data.js"></script>
  <script>
    // Helper pour URL params
    function getParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    // 1. Récupération des infos
    const mangaId = getParam('manga');
    const chapId = getParam('chap');
    const lang = getParam('lang') || 'fr';
    const manga = mangas.find(m => m.id === mangaId);
    const chapter = manga && manga.chapters.find(c => c.id === chapId);

    if (!manga || !chapter) {
      document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>Erreur : chapitre/manga introuvable !</h2>";
      throw new Error("Manga/chapter not found");
    }

    // 2. Générer la liste des pages
    const numPages = chapter.numPages || 1;
    const pageFolder = chapter.pages[lang];
    const folder = pageFolder.endsWith('/') ? pageFolder : pageFolder + '/';
    const pages = Array.from({length: numPages}, (_,i)=>`${folder}${i+1}.png`);

    // 3. Reader logic
    let curPage = 0;
    const mainImage = document.getElementById('main-image');
    const thumbs = document.getElementById('thumbs');
    const overlay = document.getElementById('overlay');
    const mangatitle = document.getElementById('mangatitle');
    const chaptitle = document.getElementById('chaptitle');
    const pageindicator = document.getElementById('page-indicator');

    function showPage(idx, scrollThumb=true) {
      curPage = idx;
      mainImage.src = pages[idx];
      Array.from(thumbs.children).forEach((thumb,i) => thumb.classList.toggle('selected', i===idx));
      pageindicator.textContent = `Page ${idx+1} / ${pages.length}`;
      if (scrollThumb && thumbs.children[idx]) thumbs.children[idx].scrollIntoView({behavior:'smooth',inline:'center'});
    }

    mainImage.onclick = () => { overlay.style.display = 'flex'; }
    overlay.onclick = (e) => { if(e.target===overlay) overlay.style.display='none'; }
    document.getElementById('prev-btn').onclick = () => {
      if(curPage > 0) showPage(curPage-1);
      overlay.style.display='none';
    };
    document.getElementById('next-btn').onclick = () => {
      if(curPage < pages.length-1) showPage(curPage+1);
      overlay.style.display='none';
    };
    document.getElementById('back-btn').onclick = () => {
      window.location.href = `manga-hub.html?id=${encodeURIComponent(manga.id)}`;
    };

    // Miniatures
    thumbs.innerHTML = '';
    for(let i=0; i<pages.length; ++i) {
      const img = document.createElement('img');
      img.src = pages[i];
      img.className = 'thumb';
      img.onclick = () => { showPage(i); };
      thumbs.appendChild(img);
    }

    // Titre et infos
    mangatitle.textContent = manga.title;
    chaptitle.textContent = chapter.title?.[lang] || '';
    showPage(0);

    // Swipe mobile (pour navigation tactile)
    let touchStartX = 0;
    mainImage.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; });
    mainImage.addEventListener('touchend', e => {
      const dx = e.changedTouches[0].clientX - touchStartX;
      if (Math.abs(dx) > 50) {
        if (dx < 0 && curPage < pages.length-1) showPage(curPage+1);
        else if (dx > 0 && curPage > 0) showPage(curPage-1);
      }
    });
    // Flèches clavier
    window.addEventListener('keydown', e => {
      if (overlay.style.display==='flex') {
        if(e.key === 'Escape') overlay.style.display='none';
        return;
      }
      if (e.key === 'ArrowLeft' && curPage < pages.length-1) showPage(curPage+1);
      if (e.key === 'ArrowRight' && curPage > 0) showPage(curPage-1);
      if (e.key === ' ') overlay.style.display = 'flex';
    });

    // Préchargement images suivantes
    function preloadNext() {
      for(let i=curPage+1; i<Math.min(curPage+4,pages.length); ++i) {
        const img = new Image();
        img.src = pages[i];
      }
    }
    mainImage.onload = preloadNext;
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Lecteur Manga</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    html,body {margin:0;padding:0; height:100%; background:#181818;}
    body {width:100vw;height:100vh;overflow:hidden;}
    #reader {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:#181818; display:flex; flex-direction:column; align-items:center; justify-content:center;
    }
    #main-image {
      max-width:100vw; max-height:100vh; display:block; margin:auto;
      background:#222; border-radius:8px; box-shadow:0 4px 28px #000a;
      cursor:pointer;
      transition: box-shadow .2s;
      user-select: none;
      -webkit-user-select: none;
    }
    #overlay {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:rgba(0,0,0,0.6); color:#fff; z-index:10;
      display:none; /* On/Off */
      align-items:center; justify-content:center;
      transition: background 0.2s;
      animation: fadein .2s;
    }
    @keyframes fadein {from { opacity:0; } to { opacity:1; }}
    #overlay-content {
      position: absolute;
      top: 50%; left: 50%; transform: translate(-50%,-50%);
      background: rgba(32,32,32,0.96);
      padding: 36px 32px 24px 32px;
      border-radius: 16px;
      box-shadow: 0 0 32px #000a;
      min-width: 260px;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 18px;
    }
    #mangatitle {font-size:1.3em; font-weight:bold;}
    #chaptitle {font-size:1.05em; color:#ffd700;}
    #page-indicator {margin:10px 0 0 0; color:#ffd700;}
    #back-btn {
      background:#ffd700; border:none; border-radius:7px; padding:11px 22px; font-size:1.05em; cursor:pointer; font-weight:bold;
      box-shadow:0 2px 8px #0005; margin-top:13px;
      transition:background .2s;
      color:#222;
    }
    #back-btn:hover {background:#fff333;}
    #toggle-overlay-btn {
      position:fixed;top:20px;right:20px;z-index:15;background:rgba(24,24,24,0.7);border:none;border-radius:50%;width:56px;height:56px;
      color:#ffd700;font-size:2.1em;font-weight:bold;cursor:pointer;box-shadow:0 2px 12px #0007;display:flex;align-items:center;justify-content:center;
      transition:background 0.2s;
    }
    #toggle-overlay-btn:hover {background:rgba(32,32,32,0.9);}
    @media (max-width:700px) {
      #main-image {max-width:98vw; max-height:70vh;}
      #overlay-content{min-width:81vw; padding:18px 4vw;}
      #toggle-overlay-btn {width:44px;height:44px;font-size:1.5em;}
    }
  </style>
</head>
<body>
  <div id="reader">
    <img id="main-image" src="" alt="Page Manga">
    <button id="toggle-overlay-btn" title="Menu/Infos">&#9776;</button>
  </div>
  <div id="overlay">
    <div id="overlay-content" onclick="event.stopPropagation()">
      <div id="mangatitle"></div>
      <div id="chaptitle"></div>
      <div id="page-indicator"></div>
      <button id="back-btn">Retour</button>
    </div>
  </div>
  <script src="manga-data.js"></script>
  <script>
    function getParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }
    // 1. Récupération des infos
    const mangaId = getParam('manga');
    const chapId = getParam('chap');
    const lang = getParam('lang') || 'fr';
    const manga = mangas.find(m => m.id === mangaId);
    const chapter = manga && manga.chapters.find(c => c.id === chapId);

    if (!manga || !chapter) {
      document.body.innerHTML = "<h2 style='color:red;text-align:center;margin-top:30vh;'>Erreur : chapitre/manga introuvable !</h2>";
      throw new Error("Manga/chapter not found");
    }

    // 2. Générer la liste des pages
    const numPages = chapter.numPages || 1;
    const pageFolder = chapter.pages[lang];
    const folder = pageFolder.endsWith('/') ? pageFolder : pageFolder + '/';
    const pages = Array.from({length: numPages}, (_,i)=>`${folder}${i+1}.png`);

    // 3. Reader logic
    let curPage = 0;
    const mainImage = document.getElementById('main-image');
    const overlay = document.getElementById('overlay');
    const mangatitle = document.getElementById('mangatitle');
    const chaptitle = document.getElementById('chaptitle');
    const pageindicator = document.getElementById('page-indicator');
    const toggleOverlayBtn = document.getElementById('toggle-overlay-btn');
    const backBtn = document.getElementById('back-btn');

    // Affichage
    function showPage(idx) {
      curPage = idx;
      mainImage.src = pages[idx];
      pageindicator.textContent = `Page ${idx+1} / ${pages.length}`;
    }
    mangatitle.textContent = manga.title;
    chaptitle.textContent = chapter.title?.[lang] || '';
    showPage(0);

    // Overlay toggle
    function showOverlay() { overlay.style.display = 'flex'; }
    function hideOverlay() { overlay.style.display = 'none'; }
    toggleOverlayBtn.onclick = showOverlay;
    backBtn.onclick = () => window.location.href = `manga-hub.html?id=${encodeURIComponent(manga.id)}`;
    overlay.onclick = hideOverlay;
    document.getElementById('overlay-content').onclick = e => e.stopPropagation();

    // Navigation horizontale style Manga Plus
    mainImage.onclick = function(e) {
      const rect = mainImage.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width;
      if (x < 0.5) { // Clic à gauche → page suivante (lecture japonaise D→G)
        if (curPage < pages.length-1) showPage(curPage+1);
      } else { // Clic à droite → page précédente
        if (curPage > 0) showPage(curPage-1);
      }
    };

    // Tap mobile (même logique)
    mainImage.addEventListener('touchend', function(e) {
      if (!e.changedTouches[0]) return;
      const rect = mainImage.getBoundingClientRect();
      const x = (e.changedTouches[0].clientX - rect.left) / rect.width;
      if (x < 0.5) {
        if (curPage < pages.length-1) showPage(curPage+1);
      } else {
        if (curPage > 0) showPage(curPage-1);
      }
    });

    // Touche clavier : Ouvre overlay = barre espace, ferme = Echap, navigation = flèches
    window.addEventListener('keydown', function(e) {
      if (overlay.style.display==='flex') {
        if(e.key === 'Escape') hideOverlay();
        return;
      }
      if (e.key === ' ' || e.key === 'Enter') showOverlay();
      else if (e.key === 'ArrowLeft' && curPage < pages.length-1) showPage(curPage+1); // Droite→gauche
      else if (e.key === 'ArrowRight' && curPage > 0) showPage(curPage-1);
    });

    // Préchargement images suivantes
    function preloadNext() {
      for(let i=curPage+1; i<Math.min(curPage+4,pages.length); ++i) {
        const img = new Image();
        img.src = pages[i];
      }
    }
    mainImage.onload = preloadNext;
  </script>
</body>
</html>
